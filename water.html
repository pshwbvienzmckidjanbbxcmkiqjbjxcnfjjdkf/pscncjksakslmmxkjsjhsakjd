<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Космический Бегун</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: manipulation;
        }

        .container {
            position: relative;
            width: 100vw;
            height: 100vh;
            max-width: 100%;
            max-height: 100%;
        }

        .game-container {
            position: relative;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 20, 0.7);
            overflow: hidden;
        }

        .stars {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite alternate;
        }

        .gem {
            position: absolute;
            background: radial-gradient(circle, #3b82f6, #1d4ed8);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.7);
            animation: pulse 1s infinite alternate;
        }

        .coin {
            position: absolute;
            background: radial-gradient(circle, #fbbf24, #ca8a04);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.7);
            animation: pulse 0.8s infinite alternate;
        }

        .bomb {
            position: absolute;
            background: radial-gradient(circle, #ef4444, #dc2626);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.7);
            animation: pulse 0.5s infinite alternate;
        }

        .player {
            position: absolute;
            width: 40px;
            height: 40px;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            transition: left 0.1s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        .pixel-skin {
            width: 100%;
            height: 100%;
            background-size: 4px 4px;
            border-radius: 50%;
        }

        .bear-skin {
            background-image: 
                linear-gradient(transparent, transparent),
                linear-gradient(transparent, transparent);
            background-position: 
                /* Eyes */
                12px 10px, 24px 10px,
                /* Nose */
                18px 18px,
                /* Mouth */
                16px 24px, 20px 24px, 24px 24px;
            background-color: #d2691e;
        }

        .cat-skin {
            background-image: 
                /* Ears */
                linear-gradient(45deg, #800080 50%, transparent 50%),
                linear-gradient(-45deg, #800080 50%, transparent 50%),
                /* Eyes */
                linear-gradient(transparent, transparent),
                linear-gradient(transparent, transparent),
                /* Nose */
                linear-gradient(transparent, transparent),
                /* Mouth */
                linear-gradient(transparent, transparent);
            background-position: 
                6px 4px, 30px 4px,
                12px 12px, 24px 12px,
                18px 18px,
                16px 24px, 20px 24px, 24px 24px;
            background-color: #800080;
        }

        .dog-skin {
            background-image: 
                /* Ears */
                linear-gradient(45deg, #1e90ff 50%, transparent 50%),
                linear-gradient(-45deg, #1e90ff 50%, transparent 50%),
                /* Eyes */
                linear-gradient(transparent, transparent),
                linear-gradient(transparent, transparent),
                /* Nose */
                linear-gradient(transparent, transparent),
                /* Mouth */
                linear-gradient(transparent, transparent);
            background-position: 
                8px 6px, 28px 6px,
                14px 14px, 22px 14px,
                18px 20px,
                16px 26px, 20px 26px, 24px 26px;
            background-color: #1e90ff;
        }

        .fox-skin {
            background-image: 
                /* Ears */
                linear-gradient(45deg, #ff4500 50%, transparent 50%),
                linear-gradient(-45deg, #ff4500 50%, transparent 50%),
                /* Eyes */
                linear-gradient(transparent, transparent),
                linear-gradient(transparent, transparent),
                /* Nose */
                linear-gradient(transparent, transparent),
                /* Mouth */
                linear-gradient(transparent, transparent);
            background-position: 
                6px 6px, 30px 6px,
                12px 14px, 24px 14px,
                18px 20px,
                16px 26px, 20px 26px, 24px 26px;
            background-color: #ff4500;
        }

        .ui {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 20;
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
        }

        .score, .time, .coins, .level-display {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px 15px;
            border-radius: 12px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .time {
            color: #ef4444;
        }

        .menu, .game-over, .level-complete, .shop, .levels, .continue-modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
            color: white;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .menu h2, .game-over h2, .level-complete h2, .shop h2, .levels h2, .continue-modal h2 {
            font-size: 2.8em;
            margin-bottom: 20px;
            color: #8a2be2;
            text-shadow: 0 0 15px rgba(138, 43, 226, 0.8);
        }

        .btn {
            background: linear-gradient(45deg, #8a2be2, #ff69b4);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 30px;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.6);
            margin: 12px;
            min-width: 140px;
            font-weight: bold;
        }

        .btn:hover {
            transform: scale(1.08);
            box-shadow: 0 0 25px rgba(138, 43, 226, 0.9);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
        }

        .btn-danger {
            background: linear-gradient(45deg, #ef4444, #dc2626);
        }

        .btn-success {
            background: linear-gradient(45deg, #10b981, #059669);
        }

        .particle {
            position: absolute;
            pointer-events: none;
            z-index: 15;
            font-size: 18px;
            animation: float-up 1s ease-out forwards;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
        }

        .score-particle {
            color: #3b82f6;
            font-weight: bold;
        }

        .coin-particle {
            color: #fbbf24;
            font-weight: bold;
        }

        @keyframes twinkle {
            0% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            100% { transform: scale(1.2); opacity: 1; }
        }

        @keyframes float-up {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }

        .background-effect {
            position: absolute;
            width: 250px;
            height: 250px;
            border-radius: 50%;
            filter: blur(50px);
            opacity: 0.15;
            z-index: 0;
        }

        .bg-purple {
            background: #8a2be2;
            top: 15%;
            left: 10%;
        }

        .bg-pink {
            background: #ff69b4;
            top: 25%;
            right: 15%;
        }

        .bg-blue {
            background: #3b82f6;
            bottom: 15%;
            left: 20%;
        }

        .shop-grid, .levels-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            width: 100%;
            margin: 25px 0;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
        }

        .skin-item, .level-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .skin-item:hover, .level-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-8px);
        }

        .skin-item.selected, .level-item.completed {
            border-color: #8a2be2;
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.5);
        }

        .skin-item.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .skin-info {
            font-size: 1.1em;
            margin: 10px 0;
        }

        .skin-price, .level-score {
            font-weight: bold;
        }

        .blue-coin {
            color: #3b82f6;
        }

        .yellow-coin {
            color: #fbbf24;
        }

        .total-coins {
            font-size: 1.4em;
            margin: 15px 0;
            color: #fbbf24;
            font-weight: bold;
        }

        .touch-zone {
            position: absolute;
            width: 50%;
            height: 100%;
            z-index: 5;
            opacity: 0;
        }

        .left-zone {
            left: 0;
        }

        .right-zone {
            right: 0;
        }

        .ad-reward {
            background: linear-gradient(45deg, #10b981, #059669);
            padding: 15px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
            font-size: 1.1em;
        }

        .level-number {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .completed-mark {
            color: #10b981;
            font-weight: bold;
        }

        @media (max-width: 480px) {
            .menu h2, .game-over h2, .level-complete h2, .shop h2, .levels h2 {
                font-size: 2.2em;
            }
            
            .btn {
                font-size: 1.1em;
                padding: 12px 24px;
            }
            
            .player {
                width: 35px;
                height: 35px;
            }
            
            .ui {
                top: 15px;
                left: 15px;
                right: 15px;
            }
            
            .score, .time, .coins, .level-display {
                padding: 8px 12px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="game-container" id="game-container">
            <div class="background-effect bg-purple"></div>
            <div class="background-effect bg-pink"></div>
            <div class="background-effect bg-blue"></div>
            
            <div class="touch-zone left-zone" id="left-zone"></div>
            <div class="touch-zone right-zone" id="right-zone"></div>
            
            <div class="ui">
                <div class="level-display">Уровень: <span id="level">1</span></div>
                <div class="score">Очки: <span id="score">0</span></div>
                <div class="coins">Монеты: <span id="coins">0</span></div>
                <div class="time">Время: <span id="time">30</span>с</div>
            </div>

            <div class="stars" id="stars"></div>
            <div class="player" id="player">
                <div class="pixel-skin bear-skin"></div>
            </div>
            
            <div class="menu" id="menu">
                <h2>КОСМИЧЕСКИЙ БЕГУН</h2>
                <p>Собирай звёзды и монеты в космосе!</p>
                <button class="btn" id="start-btn">НАЧАТЬ ИГРУ</button>
                <button class="btn btn-secondary" id="levels-btn">ПРОЙДЕННЫЕ</button>
                <button class="btn btn-secondary" id="shop-btn">МАГАЗИН</button>
            </div>

            <div class="game-over" id="game-over" style="display: none;">
                <h2>ИГРА ОКОНЧЕНА</h2>
                <p>Очки: <span id="final-score">0</span></p>
                <p>Лучший результат: <span id="best-score">0</span></p>
                <p>Монеты: <span id="total-coins">0</span></p>
                <button class="btn" id="play-again-btn">ИГРАТЬ СНОВА</button>
                <button class="btn btn-secondary" id="watch-ad-btn">ПОСМОТРЕТЬ РЕКЛАМУ</button>
                <button class="btn btn-secondary" id="menu-btn">ГЛАВНОЕ МЕНЮ</button>
            </div>

            <div class="level-complete" id="level-complete" style="display: none;">
                <h2>УРОВЕНЬ ПРОЙДЕН!</h2>
                <p>Очки: <span id="level-score">0</span></p>
                <p>Монет получено: <span id="coins-earned">0</span></p>
                <p>Всего монет: <span id="total-coins-level">0</span></p>
                <button class="btn" id="next-level-btn">СЛЕДУЮЩИЙ УРОВЕНЬ</button>
                <button class="btn btn-secondary" id="menu-btn-level">ГЛАВНОЕ МЕНЮ</button>
            </div>

            <div class="shop" id="shop" style="display: none;">
                <h2>МАГАЗИН</h2>
                <div class="total-coins">Монеты: <span id="shop-coins">0</span></div>
                
                <div class="ad-reward">
                    <p>📺 Посмотри рекламу и получи 5-10 монет!</p>
                    <button class="btn btn-success" id="watch-ad-coins-btn">ПОСМОТРЕТЬ РЕКЛАМУ</button>
                </div>
                
                <div class="shop-grid">
                    <div class="skin-item selected" data-skin="bear" data-price="0">
                        <div class="pixel-skin bear-skin" style="margin: 0 auto 15px;"></div>
                        <div class="skin-info">Медвежонок</div>
                        <div class="skin-price">БЕСПЛАТНО</div>
                    </div>
                    <div class="skin-item" data-skin="cat" data-price="50">
                        <div class="pixel-skin cat-skin" style="margin: 0 auto 15px;"></div>
                        <div class="skin-info">Котёнок</div>
                        <div class="skin-price">50 монет</div>
                    </div>
                    <div class="skin-item" data-skin="dog" data-price="75">
                        <div class="pixel-skin dog-skin" style="margin: 0 auto 15px;"></div>
                        <div class="skin-info">Щенок</div>
                        <div class="skin-price">75 монет</div>
                    </div>
                    <div class="skin-item" data-skin="fox" data-price="100">
                        <div class="pixel-skin fox-skin" style="margin: 0 auto 15px;"></div>
                        <div class="skin-info">Лисёнок</div>
                        <div class="skin-price">100 монет</div>
                    </div>
                </div>
                <button class="btn btn-secondary" id="back-btn">НАЗАД В МЕНЮ</button>
            </div>

            <div class="levels" id="levels" style="display: none;">
                <h2>ПРОЙДЕННЫЕ УРОВНИ</h2>
                <div class="total-coins">Монеты: <span id="levels-coins">0</span></div>
                <div class="levels-grid" id="levels-grid">
                    <!-- Levels will be populated dynamically -->
                </div>
                <button class="btn btn-secondary" id="back-to-menu-btn">НАЗАД В МЕНЮ</button>
            </div>

            <div class="continue-modal" id="continue-modal" style="display: none;">
                <h2>ПРОДОЛЖИТЬ ИГРУ?</h2>
                <p>Вы можете продолжить с уровня <span id="continue-level">1</span></p>
                <p>Очки: <span id="continue-score">0</span></p>
                <button class="btn" id="continue-btn">ПРОДОЛЖИТЬ</button>
                <button class="btn btn-secondary" id="watch-ad-continue-btn">ПОСМОТРЕТЬ РЕКЛАМУ</button>
                <button class="btn btn-danger" id="restart-btn">НАЧАТЬ СНАЧАЛА</button>
            </div>
        </div>
    </div>

    <script>
        // Game variables
        let gameState = 'menu';
        let player = { x: 50, size: 40 };
        let collectibles = [];
        let score = 0;
        let timeLeft = 30;
        let currentLevel = 1;
        let bestScore = parseInt(localStorage.getItem('cosmicRunnerBest')) || 0;
        let totalCoins = parseInt(localStorage.getItem('cosmicRunnerCoins')) || 0;
        let currentSkin = localStorage.getItem('cosmicRunnerSkin') || 'bear';
        let purchasedSkins = JSON.parse(localStorage.getItem('cosmicRunnerPurchased')) || ['bear'];
        let completedLevels = JSON.parse(localStorage.getItem('cosmicRunnerCompletedLevels')) || {};
        let gameLoop;
        let lastMoveTime = 0;
        let moveCooldown = 80;
        let continueData = null;
        let isGameRunning = false;

        // DOM elements
        const gameContainer = document.getElementById('game-container');
        const playerEl = document.getElementById('player');
        const collectiblesEl = document.getElementById('stars');
        const scoreEl = document.getElementById('score');
        const timeEl = document.getElementById('time');
        const coinsEl = document.getElementById('coins');
        const levelEl = document.getElementById('level');
        const menuEl = document.getElementById('menu');
        const gameOverEl = document.getElementById('game-over');
        const levelCompleteEl = document.getElementById('level-complete');
        const shopEl = document.getElementById('shop');
        const levelsEl = document.getElementById('levels');
        const continueModalEl = document.getElementById('continue-modal');
        const startBtn = document.getElementById('start-btn');
        const playAgainBtn = document.getElementById('play-again-btn');
        const nextLevelBtn = document.getElementById('next-level-btn');
        const menuBtn = document.getElementById('menu-btn');
        const menuBtnLevel = document.getElementById('menu-btn-level');
        const backBtn = document.getElementById('back-btn');
        const shopBtn = document.getElementById('shop-btn');
        const levelsBtn = document.getElementById('levels-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const watchAdBtn = document.getElementById('watch-ad-btn');
        const watchAdCoinsBtn = document.getElementById('watch-ad-coins-btn');
        const watchAdContinueBtn = document.getElementById('watch-ad-continue-btn');
        const continueBtn = document.getElementById('continue-btn');
        const restartBtn = document.getElementById('restart-btn');
        const finalScoreEl = document.getElementById('final-score');
        const bestScoreEl = document.getElementById('best-score');
        const totalCoinsEl = document.getElementById('total-coins');
        const levelScoreEl = document.getElementById('level-score');
        const coinsEarnedEl = document.getElementById('coins-earned');
        const totalCoinsLevelEl = document.getElementById('total-coins-level');
        const shopCoinsEl = document.getElementById('shop-coins');
        const levelsCoinsEl = document.getElementById('levels-coins');
        const levelsGrid = document.getElementById('levels-grid');
        const continueLevelEl = document.getElementById('continue-level');
        const continueScoreEl = document.getElementById('continue-score');
        const leftZone = document.getElementById('left-zone');
        const rightZone = document.getElementById('right-zone');
        const skinItems = document.querySelectorAll('.skin-item');

        // Audio context
        let audioContext = null;
        
        function setupAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(frequency, type = 'sine', duration = 0.1) {
            setupAudio();
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.type = type;
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log("Audio error:", e);
            }
        }

        function playMenuSound() {
            playSound(523.25, 'sine', 0.1);
            playSound(659.25, 'sine', 0.15);
        }

        function playSmallSound() {
            playSound(783.99, 'triangle', 0.1);
        }

        function playBigSound() {
            playSound(783.99, 'sine', 0.2);
            playSound(987.77, 'sine', 0.15);
        }

        function playBombSound() {
            playSound(200, 'square', 0.3);
            playSound(150, 'square', 0.2);
        }

        function playCoinSound() {
            playSound(659.25, 'sine', 0.1);
            playSound(783.99, 'sine', 0.08);
        }

        // Initialize displays
        function updateDisplay() {
            bestScoreEl.textContent = bestScore;
            totalCoinsEl.textContent = totalCoins;
            shopCoinsEl.textContent = totalCoins;
            levelsCoinsEl.textContent = totalCoins;
        }

        function updateSkinDisplay() {
            playerEl.innerHTML = '<div class="pixel-skin ' + currentSkin + '-skin"></div>';
        }

        function showShop() {
            menuEl.style.display = 'none';
            shopEl.style.display = 'flex';
            
            document.querySelectorAll('.skin-item').forEach(item => {
                const skin = item.dataset.skin;
                const price = parseInt(item.dataset.price);
                
                if (skin !== 'bear') {
                    if (purchasedSkins.includes(skin)) {
                        item.classList.remove('locked');
                        const priceEl = item.querySelector('.skin-price');
                        priceEl.textContent = 'КУПЛЕНО';
                        priceEl.style.color = '#10b981';
                    } else {
                        item.classList.add('locked');
                        const priceEl = item.querySelector('.skin-price');
                        priceEl.textContent = `${price} монет`;
                        priceEl.style.color = '';
                    }
                }
            });
            
            document.querySelectorAll('.skin-item').forEach(item => {
                item.classList.remove('selected');
                if (item.dataset.skin === currentSkin) {
                    item.classList.add('selected');
                }
            });
        }

        function showLevels() {
            menuEl.style.display = 'none';
            levelsEl.style.display = 'flex';
            updateLevelsDisplay();
        }

        function updateLevelsDisplay() {
            levelsGrid.innerHTML = '';
            
            // Sort levels by number and show only completed ones
            const sortedLevels = Object.keys(completedLevels)
                .map(level => parseInt(level))
                .sort((a, b) => b - a); // Show highest levels first
            
            if (sortedLevels.length === 0) {
                levelsGrid.innerHTML = '<p style="color: #888; width: 100%; text-align: center;">Нет пройденных уровней</p>';
                return;
            }
            
            sortedLevels.forEach(levelNum => {
                const levelItem = document.createElement('div');
                levelItem.className = 'level-item completed';
                levelItem.dataset.level = levelNum;
                
                levelItem.innerHTML = `
                    <div class="level-number">Уровень ${levelNum}</div>
                    <div class="pixel-skin ${completedLevels[levelNum].skin}-skin" style="margin: 0 auto 15px; width: 60px; height: 60px;"></div>
                    <div class="level-info">
                        <span class="completed-mark">Очки: ${completedLevels[levelNum].score}</span>
                    </div>
                `;
                
                levelItem.addEventListener('click', () => {
                    playMenuSound();
                    startLevel(parseInt(levelItem.dataset.level));
                });
                
                levelsGrid.appendChild(levelItem);
            });
        }

        function showMenu() {
            gameState = 'menu';
            if (isGameRunning) {
                isGameRunning = false;
                if (gameLoop) {
                    cancelAnimationFrame(gameLoop);
                }
            }
            
            menuEl.style.display = 'flex';
            gameOverEl.style.display = 'none';
            levelCompleteEl.style.display = 'none';
            shopEl.style.display = 'none';
            levelsEl.style.display = 'none';
            continueModalEl.style.display = 'none';
            
            player.x = (gameContainer.offsetWidth - player.size) / 2;
            playerEl.style.left = player.x + 'px';
            
            checkContinueData();
        }

        function checkContinueData() {
            continueData = JSON.parse(localStorage.getItem('cosmicRunnerContinue'));
            if (continueData) {
                startBtn.textContent = 'ПРОДОЛЖИТЬ ИГРУ';
                startBtn.onclick = () => {
                    playMenuSound();
                    showContinueModal();
                };
            } else {
                startBtn.textContent = 'НАЧАТЬ ИГРУ';
                startBtn.onclick = () => {
                    playMenuSound();
                    startGame();
                };
            }
        }

        function showContinueModal() {
            if (!continueData) return;
            
            continueLevelEl.textContent = continueData.level;
            continueScoreEl.textContent = continueData.score;
            continueModalEl.style.display = 'flex';
        }

        function continueGame() {
            if (!continueData) return;
            
            currentLevel = continueData.level;
            score = continueData.score;
            timeLeft = 30;
            
            levelEl.textContent = currentLevel;
            scoreEl.textContent = score;
            timeEl.textContent = timeLeft;
            coinsEl.textContent = totalCoins;
            
            gameState = 'playing';
            continueModalEl.style.display = 'none';
            
            collectibles = [];
            collectiblesEl.innerHTML = '';
            
            startGameLoop();
        }

        function watchAdForContinue() {
            const reward = Math.floor(Math.random() * 6) + 5;
            totalCoins += reward;
            saveGame();
            
            updateDisplay();
            
            if (continueData) {
                continueModalEl.style.display = 'none';
                continueGame();
            } else {
                gameOverEl.style.display = 'none';
                showMenu();
            }
            
            alert(`Вы получили ${reward} монет за просмотр рекламы!`);
        }

        function watchAdForCoins() {
            const reward = Math.floor(Math.random() * 6) + 5;
            totalCoins += reward;
            saveGame();
            
            updateDisplay();
            document.getElementById('shop-coins').textContent = totalCoins;
            document.getElementById('levels-coins').textContent = totalCoins;
            document.getElementById('total-coins').textContent = totalCoins;
            
            alert(`Вы получили ${reward} монет за просмотр рекламы!`);
        }

        function startGame() {
            currentLevel = 1;
            startNewGame();
        }

        function nextLevel() {
            currentLevel++;
            startNewGame();
        }

        function startNewGame() {
            levelEl.textContent = currentLevel;
            gameState = 'playing';
            menuEl.style.display = 'none';
            
            score = 0;
            timeLeft = 30;
            scoreEl.textContent = score;
            timeEl.textContent = timeLeft;
            coinsEl.textContent = totalCoins;
            
            collectibles = [];
            collectiblesEl.innerHTML = '';
            
            startGameLoop();
            
            const timer = setInterval(() => {
                if (gameState !== 'playing') {
                    clearInterval(timer);
                    return;
                }
                
                timeLeft--;
                timeEl.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    completeLevel();
                }
            }, 1000);
        }

        function startGameLoop() {
            isGameRunning = true;
            
            const gameLoop = () => {
                if (!isGameRunning) return;
                
                updateGame();
                gameLoop = requestAnimationFrame(gameLoop);
            };
            
            gameLoop();
        }

        function resetGame() {
            currentLevel = 1;
            gameState = 'playing';
            gameOverEl.style.display = 'none';
            continueModalEl.style.display = 'none';
            
            score = 0;
            timeLeft = 30;
            scoreEl.textContent = score;
            timeEl.textContent = timeLeft;
            coinsEl.textContent = totalCoins;
            
            collectibles = [];
            collectiblesEl.innerHTML = '';
            
            startGameLoop();
            
            const timer = setInterval(() => {
                if (gameState !== 'playing') {
                    clearInterval(timer);
                    return;
                }
                
                timeLeft--;
                timeEl.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    completeLevel();
                }
            }, 1000);
            
            localStorage.removeItem('cosmicRunnerContinue');
            checkContinueData();
        }

        function completeLevel() {
            if (!isGameRunning) return;
            isGameRunning = false;
            
            gameState = 'levelComplete';
            
            const coinsEarned = Math.floor(score / 5);
            totalCoins += coinsEarned;
            
            // Save completed level
            completedLevels[currentLevel] = {
                score: score,
                skin: currentSkin,
                timestamp: Date.now()
            };
            
            saveGame();
            
            levelScoreEl.textContent = score;
            coinsEarnedEl.textContent = coinsEarned;
            totalCoinsLevelEl.textContent = totalCoins;
            
            if (score > bestScore) {
                bestScore = score;
                localStorage.setItem('cosmicRunnerBest', bestScore);
            }
            
            levelCompleteEl.style.display = 'flex';
        }

        function endGame() {
            if (!isGameRunning) return;
            isGameRunning = false;
            
            gameState = 'gameOver';
            
            const coinsEarned = Math.floor(score / 5);
            totalCoins += coinsEarned;
            
            saveGame();
            
            finalScoreEl.textContent = score;
            bestScoreEl.textContent = bestScore;
            totalCoinsEl.textContent = totalCoins;
            
            // Save continue data
            localStorage.setItem('cosmicRunnerContinue', JSON.stringify({
                level: currentLevel,
                score: score
            }));
            
            gameOverEl.style.display = 'flex';
            checkContinueData();
        }

        function saveGame() {
            localStorage.setItem('cosmicRunnerBest', bestScore);
            localStorage.setItem('cosmicRunnerCoins', totalCoins);
            localStorage.setItem('cosmicRunnerPurchased', JSON.stringify(purchasedSkins));
            localStorage.setItem('cosmicRunnerCompletedLevels', JSON.stringify(completedLevels));
        }

        function movePlayer(direction) {
            if (gameState !== 'playing') return;
            
            const now = Date.now();
            if (now - lastMoveTime < moveCooldown) return;
            
            lastMoveTime = now;
            
            const containerWidth = gameContainer.offsetWidth;
            const playerWidth = player.size;
            const moveAmount = 45;
            
            if (direction === 'left') {
                player.x = Math.max(0, player.x - moveAmount);
            } else if (direction === 'right') {
                player.x = Math.min(containerWidth - playerWidth, player.x + moveAmount);
            }
            
            playerEl.style.left = player.x + 'px';
        }

        function createCollectible() {
            if (collectibles.length > 25) return;
            
            // Adjust probabilities based on level
            const baseStarProb = 0.6;
            const baseGemProb = 0.2;
            const baseCoinProb = 0.15;
            const baseBombProb = 0.05;
            
            // Make game harder as level increases
            const levelFactor = 1 + (currentLevel - 1) * 0.1;
            const bombChance = currentLevel >= 3 ? baseBombProb * levelFactor : 0;
            
            const rand = Math.random();
            let type;
            
            if (rand < bombChance) {
                type = 'bomb';
            } else if (rand < bombChance + baseCoinProb / levelFactor) {
                type = 'coin';
            } else if (rand < bombChance + baseCoinProb / levelFactor + baseGemProb / levelFactor) {
                type = 'gem';
            } else {
                type = 'star';
            }
            
            const size = type === 'coin' ? 20 : 
                        type === 'gem' ? 18 : 
                        type === 'bomb' ? 16 : 10;
            
            const speed = (Math.random() * 1.5 + 1.5) + (currentLevel * 0.2);
            
            const collectible = {
                id: Date.now() + Math.random(),
                x: Math.random() * (gameContainer.offsetWidth - 15),
                y: -20,
                size: size,
                speed: speed,
                type: type
            };
            
            collectibles.push(collectible);
            
            const el = document.createElement('div');
            el.className = collectible.type;
            el.style.left = collectible.x + 'px';
            el.style.top = collectible.y + 'px';
            el.style.width = collectible.size + 'px';
            el.style.height = collectible.size + 'px';
            el.dataset.id = collectible.id;
            
            collectiblesEl.appendChild(el);
        }

        function createParticle(x, y, type, value = '') {
            const particle = document.createElement('div');
            particle.className = `particle ${type === 'score' ? 'score-particle' : type === 'coin' ? 'coin-particle' : ''}`;
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            particle.textContent = value || (type === 'gem' ? '+10' : type === 'coin' ? '+1🪙' : type === 'bomb' ? '💥' : '⭐');
            
            document.querySelector('.game-container').appendChild(particle);
            
            setTimeout(() => {
                if (particle.parentElement) {
                    particle.remove();
                }
            }, 1000);
        }

        function updateGame() {
            // Create new collectibles with decreasing frequency as level increases
            if (Math.random() < 0.03 * (3 / Math.max(1, currentLevel * 0.5))) {
                createCollectible();
            }
            
            // Update positions and check collisions
            const elements = document.querySelectorAll('.star, .gem, .coin, .bomb');
            const playerRect = playerEl.getBoundingClientRect();
            
            elements.forEach(el => {
                const id = el.dataset.id;
                const item = collectibles.find(s => s.id == id);
                
                if (item) {
                    item.y += item.speed;
                    el.style.top = item.y + 'px';
                    
                    // Remove items that are off screen
                    if (item.y > gameContainer.offsetHeight) {
                        const index = collectibles.indexOf(item);
                        if (index > -1) {
                            collectibles.splice(index, 1);
                        }
                        if (el.parentElement) {
                            el.remove();
                        }
                        return;
                    }
                    
                    // Check collision with player only if game is still playing
                    if (gameState === 'playing' && item.y > gameContainer.offsetHeight - 70 && item.y < gameContainer.offsetHeight - 30) {
                        const itemRect = el.getBoundingClientRect();
                        
                        if (playerRect.left < itemRect.right && 
                            playerRect.right > itemRect.left &&
                            playerRect.top < itemRect.bottom &&
                            playerRect.bottom > itemRect.top) {
                            
                            if (item.type === 'bomb') {
                                playBombSound();
                                endGame();
                            } else {
                                const isCoin = item.type === 'coin';
                                const isGem = item.type === 'gem';
                                const points = isGem ? 10 : (isCoin ? 0 : 1);
                                const coinsEarned = isCoin ? 1 : 0;
                                
                                if (points > 0) {
                                    score += points;
                                    scoreEl.textContent = score;
                                    if (isGem) {
                                        playBigSound();
                                    } else {
                                        playSmallSound();
                                    }
                                }
                                
                                if (coinsEarned > 0) {
                                    totalCoins += coinsEarned;
                                    coinsEl.textContent = totalCoins;
                                    playCoinSound();
                                }
                                
                                const index = collectibles.indexOf(item);
                                if (index > -1) {
                                    collectibles.splice(index, 1);
                                }
                                if (el.parentElement) {
                                    el.remove();
                                }
                                
                                createParticle(
                                    itemRect.left - gameContainer.getBoundingClientRect().left + itemRect.width/2,
                                    itemRect.top - gameContainer.getBoundingClientRect().top + itemRect.height/2,
                                    item.type
                                );
                                
                                if (points > 0 || coinsEarned > 0) {
                                    createParticle(
                                        playerRect.left - gameContainer.getBoundingClientRect().left + playerRect.width/2,
                                        playerRect.top - gameContainer.getBoundingClientRect().top - 25,
                                        isCoin ? 'coin' : 'score',
                                        isCoin ? '+1🪙' : isGem ? '+10' : '+1'
                                    );
                                }
                            }
                        }
                    }
                }
            });
        }

        // Event listeners
        startBtn.addEventListener('click', () => {
            playMenuSound();
            if (startBtn.textContent === 'ПРОДОЛЖИТЬ ИГРУ' && continueData) {
                showContinueModal();
            } else {
                startGame();
            }
        });

        playAgainBtn.addEventListener('click', () => {
            playMenuSound();
            resetGame();
        });

        nextLevelBtn.addEventListener('click', () => {
            playMenuSound();
            nextLevel();
        });

        menuBtn.addEventListener('click', () => {
            playMenuSound();
            showMenu();
        });

        menuBtnLevel.addEventListener('click', () => {
            playMenuSound();
            showMenu();
        });

        backBtn.addEventListener('click', () => {
            playMenuSound();
            showMenu();
        });

        shopBtn.addEventListener('click', () => {
            playMenuSound();
            showShop();
        });

        levelsBtn.addEventListener('click', () => {
            playMenuSound();
            showLevels();
        });

        backToMenuBtn.addEventListener('click', () => {
            playMenuSound();
            showMenu();
        });

        watchAdBtn.addEventListener('click', () => {
            playMenuSound();
            watchAdForContinue();
        });

        watchAdCoinsBtn.addEventListener('click', () => {
            playMenuSound();
            watchAdForCoins();
        });

        watchAdContinueBtn.addEventListener('click', () => {
            playMenuSound();
            watchAdForContinue();
        });

        continueBtn.addEventListener('click', () => {
            playMenuSound();
            continueGame();
        });

        restartBtn.addEventListener('click', () => {
            playMenuSound();
            resetGame();
        });

        // Touch controls
        leftZone.addEventListener('touchstart', (e) => {
            e.preventDefault();
            movePlayer('left');
        }, { passive: false });

        rightZone.addEventListener('touchstart', (e) => {
            e.preventDefault();
            movePlayer('right');
        }, { passive: false });

        // Mouse controls
        leftZone.addEventListener('mousedown', (e) => {
            e.preventDefault();
            movePlayer('left');
        });

        rightZone.addEventListener('mousedown', (e) => {
            e.preventDefault();
            movePlayer('right');
        });

        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            if (gameState === 'playing') {
                if (e.key === 'ArrowLeft') {
                    movePlayer('left');
                } else if (e.key === 'ArrowRight') {
                    movePlayer('right');
                }
            }
        });

        // Skin shop
        document.querySelectorAll('.skin-item').forEach(item => {
            item.addEventListener('click', () => {
                const skin = item.dataset.skin;
                const price = parseInt(item.dataset.price);
                
                if (item.classList.contains('selected')) {
                    return;
                }
                
                if (item.classList.contains('locked')) {
                    if (totalCoins >= price) {
                        totalCoins -= price;
                        purchasedSkins.push(skin);
                        saveGame();
                        
                        const priceEl = item.querySelector('.skin-price');
                        priceEl.textContent = 'КУПЛЕНО';
                        priceEl.style.color = '#10b981';
                        item.classList.remove('locked');
                    } else {
                        playBombSound();
                        alert('Недостаточно монет!');
                        return;
                    }
                }
                
                document.querySelectorAll('.skin-item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                
                currentSkin = skin;
                localStorage.setItem('cosmicRunnerSkin', skin);
                updateSkinDisplay();
                playMenuSound();
            });
        });

        // Initial setup
        updateDisplay();
        updateSkinDisplay();
        checkContinueData();
    </script>
</body>
</html>
